<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„Ø¶ÙˆØ¦ÙŠ</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121826; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        
        .scanner-container { width: 100%; max-width: 500px; padding: 20px; text-align: center; }
        
        #reader { width: 100%; border-radius: 15px; border: 5px solid #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.5); background: black; }
        
        .status-box { margin-top: 20px; padding: 20px; border-radius: 10px; background: #1e293b; min-height: 100px; border: 1px solid #334155; }
        
        h1 { color: #38bdf8; margin-bottom: 5px; }
        p { color: #94a3b8; margin-top: 0; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­ */
        .success { border-color: #4caf50 !important; }
        .success-text { color: #4caf50; font-size: 20px; font-weight: bold; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙØ´Ù„ */
        .error-text { color: #f44336; font-size: 18px; font-weight: bold; }

        .scan-line { width: 100%; height: 2px; background: red; position: absolute; top: 50%; animation: scan 2s infinite; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="scanner-container">
        <h1>ğŸ“· Ø¬Ù‡Ø§Ø² ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h1>
        <p>Ø¶Ø¹ Ø±Ù…Ø² QR Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
        
        <div id="reader"></div>

        <div class="status-box" id="resultBox">
            <span style="font-size: 40px;">â³</span><br>
            Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...
        </div>
    </div>

    <audio id="beepSound" src="https://www.soundjay.com/button/beep-07.mp3"></audio>

    <script>
        let isScanning = true;

        function onScanSuccess(decodedText, decodedResult) {
            if (!isScanning) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹

            // 1. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ
            document.getElementById('beepSound').play();
            document.getElementById('reader').style.borderColor = '#4caf50';
            isScanning = false; // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­ Ù…Ø¤Ù‚ØªØ§Ù‹

            // 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ±
            document.getElementById('resultBox').innerHTML = `<span style="font-size: 40px;">ğŸ”„</span><br>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...`;

            // Ù†Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù€ ID Ù…Ù† Ø§Ù„Ù†Øµ (Ù„Ø£Ù†Ù†Ø§ ÙƒØªØ¨Ù†Ø§ ÙÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: Employee: Name | ID: ...)
            // Ø³Ù†Ø¨Ø­Ø« Ø¹Ù† ID Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ø£Ùˆ Ù†Ø±Ø³Ù„ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙˆØ§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ø§Ù„Ø¬Ù‡
            // ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¬Ø¹Ù„Ù†Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù†ØµÙŠØ©ØŒ Ø§Ù„Ø£ÙØ¶Ù„ Ø¬Ø¹Ù„Ù‡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID ÙÙ‚Ø· Ø£Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ ID
            
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¯Ù‚Ø©ØŒ Ø³Ø£ÙØªØ±Ø¶ Ø£Ù†Ùƒ Ø³ØªØ±Ø³Ù„ Ø§Ù„Ù†Øµ ÙƒØ§Ù…Ù„Ø§Ù‹ ÙˆØ§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªØ®Ø±Ø¬ Ø§Ù„Ù€ ID
            
            fetch('/api/scan-attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qrData: decodedText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('resultBox').innerHTML = `
                        <span style="font-size: 40px;">âœ…</span><br>
                        <span class="success-text">${data.message}</span><br>
                        ${data.name}
                    `;
                } else {
                    document.getElementById('resultBox').innerHTML = `
                        <span style="font-size: 40px;">âŒ</span><br>
                        <span class="error-text">${data.message}</span>
                    `;
                    document.getElementById('reader').style.borderColor = 'red';
                }

                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³Ø­ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    isScanning = true;
                    document.getElementById('resultBox').innerHTML = `<span style="font-size: 40px;">â³</span><br>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø³Ø­...`;
                    document.getElementById('reader').style.borderColor = '#38bdf8';
                }, 3000);
            })
            .catch(err => {
                console.error(err);
                isScanning = true;
            });
        }

        function onScanFailure(error) {
            // Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙƒÙˆØ¯)
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: {width: 250, height: 250} }, 
            /* verbose= */ false);
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    </script>
</body>
</html>